package scripts

import typo.{Nullability, NullabilityOverride, Source, RelPath, db}

import java.nio.file.Path
import java.sql.{Connection, DriverManager}
import java.util

object GeneratedSources {
  def main(args: Array[String]): Unit = {
    implicit val c: Connection = {
      val url = "jdbc:postgresql://localhost:6432/postgres"
      val props = new util.Properties
      props.setProperty("user", "postgres")
      props.setProperty("password", "password")
      props.setProperty("port", "6432")
      DriverManager.getConnection(url, props)
    }

    val header =
      """|/**
         | * File has been automatically generated by `typo` for internal use.
         | *
         | * IF YOU CHANGE THIS FILE YOUR CHANGES WILL BE OVERWRITTEN.
         | *
         | * (If you're developing `typo` and want to change it: run `bleep generate-sources`)
         | */
         |""".stripMargin

    val buildDir = Path.of(sys.props("user.dir"))
    val typoSources = buildDir.resolve("typo/generated-and-checked-in")
    val sqlScriptDir = buildDir.resolve("sql")

    val selector = typo.Selector.relationNames(
      "columns",
      "key_column_usage",
      "pg_namespace",
      "referential_constraints",
      "table_constraints",
      "tables",
      "foo"
    )

    val nullabilityOverride: NullabilityOverride = {
      // postgres has problems with a left join in this query
      case (Source.SqlFile(RelPath(List("custom", "domains.sql"))), db.ColName("collation" | "constraintName")) =>
        Some(Nullability.Nullable)
      case (_, _) =>
        None
    }

    val files: typo.Generated = {
      val options = typo.Options(
        pkg = "typo.generated",
        jsonLib = typo.JsonLibName.PlayJson,
        dbLib = typo.DbLibName.Anorm,
        header = header,
        nullabilityOverride = nullabilityOverride,
        debugTypes = true
      )
      typo.fromDbAndScripts(options, sqlScriptDir, selector)
    }

    files.overwriteFolder(typoSources, soft = true)

    import scala.sys.process._
    List("git", "add", "-f", typoSources.toString).!!
    ()
  }
}
